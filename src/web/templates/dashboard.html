{% extends "base.html" %}

{% block title %}Dashboard - X Bot{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block header_actions %}
<button class="btn btn-secondary" onclick="location.reload()">
    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
    </svg>
    Refresh
</button>
{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Stats Cards - Activity -->
    <div class="stats-row">
        <div class="stats-category">
            <a href="/posts?tab=written" class="stat-card stat-card-link">
                <div class="stat-icon">üìù</div>
                <div class="stat-content">
                    <div class="stat-value">{{ state.counters.get('posts_today', 0) }}</div>
                    <div class="stat-label">Posts Today</div>
                </div>
            </a>
            
            <div class="stat-card">
                <div class="stat-icon">üí¨</div>
                <div class="stat-content">
                    <div class="stat-value">{{ state.counters.get('replies_today', 0) }}</div>
                    <div class="stat-label">Replies Today</div>
                </div>
            </div>
        </div>
        
        <div class="stats-category">
            <a href="/posts?tab=interested" class="stat-card stat-card-link">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-content">
                    <div class="stat-value">{{ state.interesting_posts_queue | length }}/{{ config.scheduler.inspiration_batch_size }}</div>
                    <div class="stat-label">Interesting</div>
                </div>
            </a>
            
            <div class="stat-card stat-card-disabled" title="Coming soon">
                <div class="stat-icon">üîî</div>
                <div class="stat-content">
                    <div class="stat-value">{{ state.notifications_queue | length }}</div>
                    <div class="stat-label">Notifications</div>
                </div>
            </div>
        </div>
        
        <div class="stats-category">
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                    <div class="stat-value">{{ job_queue.size }}</div>
                    <div class="stat-label">Jobs Queued</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bot Status -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Status</h2>
        </div>
        <div class="section-content">
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-icon">‚è±Ô∏è</span>
                    <div class="status-content">
                        <span class="status-label">Running Since</span>
                        {% if state.bot_started_at %}
                        <span class="status-value" id="running-since" data-started="{{ state.bot_started_at.isoformat() }}">
                            <span data-timestamp="{{ state.bot_started_at.isoformat() }}" data-time-format="short"></span>
                        </span>
                        <span class="status-subtext" id="uptime"></span>
                        {% else %}
                        <span class="status-value">Not started</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="status-item">
                    <span class="status-icon">‚úÖ</span>
                    <div class="status-content">
                        <span class="status-label">Last Action</span>
                        {% if state.last_action %}
                        <span class="status-value">{{ state.last_action }}</span>
                        <span class="status-subtext" data-timestamp="{{ state.last_action_time.isoformat() if state.last_action_time else '' }}" data-time-format="time-only"></span>
                        {% else %}
                        <span class="status-value">No actions yet</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="status-item">
                    <span class="status-icon">üìÖ</span>
                    <div class="status-content">
                        <span class="status-label">Next Scheduled</span>
                        <span class="status-value">~{{ config.scheduler.post_interval_hours }}h post</span>
                        <span class="status-subtext">{{ config.scheduler.reading_check_minutes }}m read</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pending Jobs (only show if queue has items) -->
    {% if not job_queue.is_empty %}
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Pending Jobs</h2>
        </div>
        <div class="section-content">
            <div class="activity-list">
                {% for job_id in job_queue.pending_jobs %}
                <div class="activity-item">
                    <span class="activity-icon">‚è≥</span>
                    <span class="activity-text">{{ job_id }}</span>
                    <span class="activity-value text-accent">waiting</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Rate Limits -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Rate Limits</h2>
        </div>
        <div class="section-content">
            <div class="rate-limits">
                <div class="rate-limit-item">
                    <div class="rate-limit-header">
                        <span>Posts</span>
                        <span>{{ state.counters.get('posts_today', 0) }} / {{ config.rate_limits.max_posts_per_day }}</span>
                    </div>
                    <div class="progress-bar">
                        {% set posts_pct = (state.counters.get('posts_today', 0) / config.rate_limits.max_posts_per_day * 100) | int %}
                        <div class="progress-fill" style="width: {{ posts_pct }}%"></div>
                    </div>
                </div>
                
                <div class="rate-limit-item">
                    <div class="rate-limit-header">
                        <span>Replies</span>
                        <span>{{ state.counters.get('replies_today', 0) }} / {{ config.rate_limits.max_replies_per_day }}</span>
                    </div>
                    <div class="progress-bar">
                        {% set replies_pct = (state.counters.get('replies_today', 0) / config.rate_limits.max_replies_per_day * 100) | int %}
                        <div class="progress-fill" style="width: {{ replies_pct }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Database Stats -->
    {% if stats %}
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Database</h2>
        </div>
        <div class="section-content">
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-item-label">Read Posts</span>
                    <span class="stat-item-value">{{ stats.get('read_posts_count', 0) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-item-label">Written Tweets</span>
                    <span class="stat-item-value">{{ stats.get('written_tweets_count', 0) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-item-label">Rejected</span>
                    <span class="stat-item-value">{{ stats.get('rejected_tweets_count', 0) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-item-label">Token Logs</span>
                    <span class="stat-item-value">{{ stats.get('token_usage_entries', 0) }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Recent Activity -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Activity</h2>
        </div>
        <div class="section-content">
            <div class="activity-list">
                {% if state.last_post_time %}
                <div class="activity-item">
                    <span class="activity-icon">üìù</span>
                    <span class="activity-text">Last post</span>
                    <span class="activity-time" data-timestamp="{{ state.last_post_time.isoformat() if state.last_post_time else '' }}" data-time-format="short"></span>
                </div>
                {% endif %}
                
                {% if state.last_notification_check_time %}
                <div class="activity-item">
                    <span class="activity-icon">üîî</span>
                    <span class="activity-text">Notification check</span>
                    <span class="activity-time" data-timestamp="{{ state.last_notification_check_time.isoformat() if state.last_notification_check_time else '' }}" data-time-format="short"></span>
                </div>
                {% endif %}
                
                <div class="activity-item">
                    <span class="activity-icon">üòä</span>
                    <span class="activity-text">Current mood</span>
                    <span class="activity-value mood-{{ state.mood }}">{{ state.mood | capitalize }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration -->
    <div class="section-card">
        <div class="section-header">
            <h2 class="section-title">Configuration</h2>
        </div>
        <div class="section-content">
            <div class="config-grid">
                <div class="config-item">
                    <span class="config-label">Provider</span>
                    <span class="config-value">{{ config.llm.provider }}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Model</span>
                    <span class="config-value font-mono">{{ config.llm.model }}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Tone</span>
                    <span class="config-value">{{ config.personality.tone | capitalize }}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Topics</span>
                    <span class="config-value">{{ config.personality.topics | join(', ') }}</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Post Interval</span>
                    <span class="config-value font-mono">{{ config.scheduler.post_interval_hours }}h ¬± {{ config.scheduler.post_jitter_hours }}h</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate and display uptime
function updateUptime() {
    const element = document.getElementById('running-since');
    const uptimeElement = document.getElementById('uptime');
    if (!element || !uptimeElement) return;
    
    const started = new Date(element.dataset.started);
    const now = new Date();
    const diff = now - started;
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    let uptimeStr = '';
    if (days > 0) uptimeStr += `${days}d `;
    if (hours > 0 || days > 0) uptimeStr += `${hours}h `;
    uptimeStr += `${minutes}m`;
    
    uptimeElement.textContent = uptimeStr + ' uptime';
}

updateUptime();
setInterval(updateUptime, 60000);
</script>
{% endblock %}
